<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clickable Map</title>
    <style>
        body {
            display: flex;
        }
        #map-container {
            flex: 1;
            border: 1px solid #ccc;
        }
        #selected-municipalities {
            flex: 0 0 300px;
            margin-left: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .clicked {
            fill: red; /* Default highlight color */
        }
        #controls {
            margin-bottom: 20px;
        }
        .color-box {
            width: 20px;
            height: 20px;
            display: inline-block;
            cursor: pointer;
            margin: 2px;
            border: 1px solid #000;
        }
        .selected-color {
            border: 2px solid #000;
        }
        .district {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ccc;
        }
        .district h4 {
            margin: 0 0 5px;
        }
    </style>
</head>
<body>
    <div id="map-container"></div>
    <div id="selected-municipalities">
        <div id="controls">
            <button id="save-district">Save District</button>
            <input type="file" id="load-district-file" style="display:none">
            <button id="load-district">Load District</button>
            <div id="color-palette">
                <h3>Select Color</h3>
                <div class="color-box" style="background-color: #e6194b;"></div>
                <div class="color-box" style="background-color: #3cb44b;"></div>
                <div class="color-box" style="background-color: #ffe119;"></div>
                <div class="color-box" style="background-color: #0082c8;"></div>
                <div class="color-box" style="background-color: #f58231;"></div>
                <div class="color-box" style="background-color: #911eb4;"></div>
                <div class="color-box" style="background-color: #46f0f0;"></div>
                <div class="color-box" style="background-color: #f032e6;"></div>
                <div class="color-box" style="background-color: #d2f53c;"></div>
                <div class="color-box" style="background-color: #fabebe;"></div>
                <div class="color-box" style="background-color: #008080;"></div>
                <div class="color-box" style="background-color: #e6beff;"></div>
                <div class="color-box" style="background-color: #aa6e28;"></div>
                <div class="color-box" style="background-color: #800000;"></div>
                <div class="color-box" style="background-color: #aaffc3;"></div>
            </div>
            <button id="implement-district">Implement Current District</button>
        </div>
        <h2>Selected Municipalities</h2>
        <p id="total-population">Total Population: 0</p>
        <ul id="municipality-list"></ul>
        <div id="implemented-districts">
            <h3>Implemented Districts</h3>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mapContainer = document.getElementById('map-container');
            const saveButton = document.getElementById('save-district');
            const loadButton = document.getElementById('load-district');
            const loadFileInput = document.getElementById('load-district-file');
            const implementButton = document.getElementById('implement-district');
            const totalPopulationElement = document.getElementById('total-population');
            const municipalityListElement = document.getElementById('municipality-list');
            const implementedDistrictsElement = document.getElementById('implemented-districts');
            const colorPalette = document.getElementById('color-palette');
            let selectedColor = '#e6194b'; // Default color
            
            const implementedDistricts = {};

            // Load the SVG file using an AJAX request
            const xhr = new XMLHttpRequest();
            xhr.open('GET', 'sc.svg', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    mapContainer.innerHTML = xhr.responseText;

                    // Get the SVG map element
                    const map = document.querySelector('svg');

                    // Load the CSV file using another AJAX request
                    const csvXhr = new XMLHttpRequest();
                    csvXhr.open('GET', 'municipalities.csv', true);
                    csvXhr.onreadystatechange = function() {
                        if (csvXhr.readyState === 4 && csvXhr.status === 200) {
                            const csvData = csvXhr.responseText;
                            const municipalitiesData = parseCSV(csvData);

                            // Object to store selected municipalities
                            const selectedMunicipalities = {};

                            // Add click event listener to the map
                            map.addEventListener('click', function(event) {
                                const clickedPath = event.target;
                                const municipalityId = clickedPath.id;
                                const municipalityData = municipalitiesData[municipalityId];

                                if (municipalityData) {
                                    clickedPath.classList.toggle('clicked');
                                    clickedPath.style.fill = selectedColor;

                                    if (selectedMunicipalities[municipalityId]) {
                                        delete selectedMunicipalities[municipalityId];
                                        clickedPath.style.fill = ''; // Reset color if unselected
                                    } else {
                                        selectedMunicipalities[municipalityId] = municipalityData;
                                    }

                                    updateSelectedMunicipalitiesDisplay(selectedMunicipalities);
                                }
                            });

                            saveButton.addEventListener('click', function() {
                                saveDistrict(selectedMunicipalities);
                            });

                            loadButton.addEventListener('click', function() {
                                loadFileInput.click();
                            });

                            loadFileInput.addEventListener('change', function(event) {
                                const file = event.target.files[0];
                                if (file) {
                                    loadDistrict(file, map, municipalitiesData, selectedMunicipalities);
                                }
                            });

                            colorPalette.addEventListener('click', function(event) {
                                if (event.target.classList.contains('color-box')) {
                                    document.querySelectorAll('.color-box').forEach(box => box.classList.remove('selected-color'));
                                    event.target.classList.add('selected-color');
                                    selectedColor = event.target.style.backgroundColor;
                                }
                            });

                            implementButton.addEventListener('click', function() {
                                implementDistrict(selectedMunicipalities, municipalitiesData, map);
                            });
                        }
                    };
                    csvXhr.send();
                }
            };
            xhr.send();

            function parseCSV(csv) {
                const lines = csv.split('\n');
                const municipalities = {};

                for (let i = 1; i < lines.length; i++) {
                    const [name, population, , id] = lines[i].split(',');

                    if (id) {
                        municipalities[id.trim()] = {
                            name: name.trim(),
                            population: parseInt(population.trim(), 10)
                        };
                    }
                }

                return municipalities;
            }

            function updateSelectedMunicipalitiesDisplay(selectedMunicipalities) {
                let totalPopulation = 0;
                municipalityListElement.innerHTML = '';

                for (const id in selectedMunicipalities) {
                    const municipality = selectedMunicipalities[id];
                    totalPopulation += municipality.population;

                    const listItem = document.createElement('li');
                    listItem.textContent = `${municipality.name} (Population: ${municipality.population})`;
                    municipalityListElement.appendChild(listItem);
                }

                totalPopulationElement.textContent = `Total Population: ${totalPopulation}`;
            }

            function updateSelectedDisctrictsDisplay(implementedDistricts) {
                let totalPopulation = 0;
                implementedDistrictsElement.innerHTML = '';

                for (const id in selectedMunicipalities) {
                    const municipality = selectedMunicipalities[id];
                    totalPopulation += municipality.population;

                    const listItem = document.createElement('li');
                    listItem.textContent = `${municipality.name} (Population: ${municipality.population})`;
                    municipalityListElement.appendChild(listItem);
                }

                totalPopulationElement.textContent = `Total Population: ${totalPopulation}`;
            }

            function saveDistrict(selectedMunicipalities) {
                const blob = new Blob([JSON.stringify(selectedMunicipalities)], { type: 'application/json' });
                //const blob = new Blob([JSON.stringify(implementedDistricts)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'district.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function loadDistrict(file, map, municipalitiesData, selectedMunicipalities) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const district = JSON.parse(event.target.result);
                    for (const id in district) {
                        selectedMunicipalities[id] = municipalitiesData[id];
                        const path = map.getElementById(id);
                        if (path) {
                            path.classList.add('clicked');
                            path.style.fill = selectedColor; // Apply selected color to loaded district
                        }
                    }
                    updateSelectedMunicipalitiesDisplay(selectedMunicipalities);
                };
                reader.readAsText(file);
            }

            function implementDistrict(selectedMunicipalities, municipalitiesData, map) {
                
                
                let totalPopulation = 0;
                let mostPopulousCity = null;
                let cityCount = Object.keys(selectedMunicipalities).length;
                for (const id in selectedMunicipalities) {
                    const municipality = selectedMunicipalities[id];
                    totalPopulation += municipality.population;

                    if (!mostPopulousCity || municipality.population > mostPopulousCity.population) {
                        mostPopulousCity = municipality;
                    }
                }
                implementedDistricts[mostPopulousCity] = {selectedMunicipalities};
                console.log(implementedDistricts);

                // Create a new district element
                const districtElement = document.createElement('div');
                districtElement.classList.add('district');
                const districtName = mostPopulousCity ? mostPopulousCity.name : 'Unnamed District';
                
                districtElement.innerHTML = `<h4>${districtName}, ${cityCount}, Pop: ${totalPopulation}</h4>`;

                // Create a list of municipalities in the district
                // const districtList = document.createElement('ul');
                // for (const id in selectedMunicipalities) {
                //     const municipality = selectedMunicipalities[id];
                //     const listItem = document.createElement('li');
                //     listItem.textContent = `${municipality.name} (Population: ${municipality.population})`;
                //     districtList.appendChild(listItem);
                // }

                //districtElement.appendChild(districtList);
                implementedDistrictsElement.appendChild(districtElement);

                // Clear the current selection
                municipalityListElement.innerHTML = '';
                totalPopulationElement.textContent = 'Total Population: 0';

                for (const id in selectedMunicipalities) {
                    const path = map.getElementById(id);
                    if (path) {
                        path.classList.remove('clicked');
                        path.style.fill = ''; // Reset color
                    }
                }

                // Clear the selectedMunicipalities object
                for (const id in selectedMunicipalities) {
                    delete selectedMunicipalities[id];
                }

            }
        });
    </script>
</body>
</html>
